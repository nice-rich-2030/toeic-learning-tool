# TOEIC リスニング実能力の実感型学習ツール - プログラム仕様書

## プログラム概要

### アーキテクチャ概念図

```
+---------------------------+
| TOEIC リスニング学習ツール |
+---------------------------+
           |
           | (構成)
           v
+---------------------------+
| UI層                      |
|                           |
| - ヘッダー (設定/コントロール) |
| - メインコンテンツ (セクション) |
| - 音声アイテム               |
+---------------------------+
           |
           | (機能)
           v
+---------------------------+
| ロジック層                  |
|                           |
| - 音声再生制御              |
| - スコア計算                |
| - 理解度評価                |
| - データ管理                |
+---------------------------+
           |
           | (保存)
           v
+---------------------------+
| データ層                   |
|                           |
| - ローカルストレージ         |
| - 音声ファイル              |
| - トランスクリプト          |
+---------------------------+
```

### 使用技術スタック

- **フロントエンド**:
  - HTML5: ページ構造の定義
  - CSS3: スタイリングとレスポンシブデザイン
  - JavaScript (ES6+): ロジック実装とDOM操作
  
- **API/ブラウザ技術**:
  - Web Audio API: 音声再生と速度制御
  - LocalStorage API: ユーザーデータの永続化
  - CSS Variables: テーマ管理（ダークモード対応）
  - Flexbox: レスポンシブレイアウト
  
- **データフォーマット**:
  - JSON: データの構造化と保存
  - CSV: トランスクリプトデータの読み込み

### 依存関係

- **外部ライブラリ**: なし（バニラJavaScriptのみで実装）
- **外部リソース**:
  - 音声ファイル (MP3形式)
  - トランスクリプトファイル (CSV形式)
  - ファビコン画像一式
- **ブラウザAPI依存**:
  - Web Audio API
  - LocalStorage API
  - Fetch API (CSVファイル取得)

## プログラム構造

### モジュール構成

本アプリケーションは、モジュール分割せずに単一のJavaScriptファイルで実装されていますが、論理的には次のモジュールに分けることができます：

1. **初期化モジュール**:
   - DOM読み込み後の初期化処理
   - ローカルストレージからのデータロード
   - イベントリスナーの設定

2. **UI管理モジュール**:
   - UI要素の生成と更新
   - テーマ切替処理
   - 進捗状況の表示更新

3. **音声制御モジュール**:
   - 音声の再生/一時停止/停止
   - 再生速度の調整
   - 再生回数のカウントと管理

4. **評価処理モジュール**:
   - 理解度評価の保存と管理
   - スコア計算
   - 自動評価機能

5. **データ管理モジュール**:
   - ローカルストレージへのデータ保存/読み込み
   - CSVデータの解析
   - データのリセット機能

### クラス階層

明示的なクラス定義はありませんが、機能的なグループ分けは以下のとおりです：

```
- グローバル変数/状態管理
  |
  |-- 音声管理関連 (currentAudio, currentAudioId, playbackRate)
  |
  |-- データストア関連 (evaluationData, playCountData, audioFiles)
  |
  |-- UI状態関連 (unitSize, activeAudioItem, darkMode)
  
- 機能グループ
  |
  |-- 初期化機能
  |   |-- loadDataFromLocalStorage()
  |   |-- loadDataFromCSV()
  |   |-- loadMockData()
  |
  |-- UI管理機能
  |   |-- updateUI()
  |   |-- createAudioItem()
  |   |-- applyTheme()
  |   |-- toggleTheme()
  |
  |-- 音声制御機能
  |   |-- playAudio()
  |   |-- playAudioForPractice()
  |   |-- pauseAudio()
  |   |-- stopAudio()
  |   |-- toggleText()
  |
  |-- 評価処理機能
  |   |-- saveEvaluation()
  |   |-- updateEvaluationBasedOnPlayCount()
  |   |-- calculateSectionScore()
  |   |-- updateProgress()
  |
  |-- データ管理機能
  |   |-- saveDataToLocalStorage()
  |   |-- resetData()
  |   |-- clearLocalStorage()
```

### データフロー

1. **起動時データフロー**:
   ```
   ブラウザ起動
     ↓
   DOMContentLoaded
     ↓
   localStorage確認 → データあり → データ読み込み
     ↓          → データなし → CSV読み込み/モックデータ生成
     ↓
   UI更新/表示
   ```

2. **音声再生時データフロー**:
   ```
   再生ボタンクリック
     ↓
   現在の再生状態確認
     ↓
   同じファイル再生 → 再生回数カウントアップ
     ↓         → 再生回数表示更新
     ↓         → 評価自動更新
     ↓
   異なるファイル再生 → 前の音声停止
     ↓          → 再生回数リセット
     ↓
   Audio要素生成/再生
     ↓
   アクティブ状態更新
     ↓
   データ保存
   ```

3. **評価更新時データフロー**:
   ```
   評価ラジオボタン選択
     ↓
   評価データ更新
     ↓
   評価日時記録
     ↓
   UI更新
     ↓
   進捗状況更新
     ↓
   データ保存
   ```

## 関数一覧

### 主要関数の概要表

| 関数名 | 用途 | 引数 | 戻り値 |
|-------|------|-----|------|
| `loadDataFromLocalStorage()` | ローカルストレージからデータを読み込む | なし | なし |
| `saveDataToLocalStorage()` | データをローカルストレージに保存 | なし | なし |
| `loadDataFromCSV()` | CSVファイルからトランスクリプトデータを読み込む | なし | Promise<void> |
| `loadMockData()` | デモ用のモックデータを生成 | なし | なし |
| `updateUI()` | UIを更新して表示する | なし | なし |
| `createAudioItem(file)` | 音声アイテム要素を生成 | file: オブジェクト | HTMLElement |
| `playAudio(file)` | 音声を再生する | file: オブジェクト | なし |
| `playAudioForPractice(file)` | 習練モードで音声を再生 | file: オブジェクト | なし |
| `pauseAudio()` | 音声を一時停止 | なし | なし |
| `stopAudio()` | 音声を停止 | なし | なし |
| `updatePlayCount(fileId)` | 再生回数表示を更新 | fileId: 文字列 | なし |
| `toggleText(fileId)` | 英文表示/非表示を切り替え | fileId: 文字列 | なし |
| `saveEvaluation(fileId, rating)` | 評価を保存 | fileId: 文字列, rating: 数値 | なし |
| `calculateSectionScore(sectionFiles)` | セクションのスコアを計算 | sectionFiles: 配列 | オブジェクト |
| `updateProgress()` | 進捗状況を更新 | なし | なし |
| `resetData()` | 評価データをリセット | なし | なし |
| `clearLocalStorage()` | ローカルストレージを完全に消去 | なし | なし |
| `toggleTheme()` | テーマ切替 | なし | なし |
| `applyTheme()` | テーマ設定を適用 | なし | なし |

### 公開API/インターフェース

本アプリケーションは外部からのAPIアクセスは想定していませんが、拡張性のために利用可能な関数インターフェースは以下の通りです：

**データ管理API**:
- `loadDataFromLocalStorage()`: 保存されたデータを読み込む
- `saveDataToLocalStorage()`: 現在のデータを保存する
- `resetData()`: 評価データをリセット
- `clearLocalStorage()`: すべてのデータをクリア

**音声制御API**:
- `playAudio(file)`: 音声ファイルを再生
- `pauseAudio()`: 再生中の音声を一時停止
- `stopAudio()`: 再生中の音声を停止
- `playAudioForPractice(file)`: 習練モードでの再生

**UI管理API**:
- `updateUI()`: UI全体を更新
- `toggleTheme()`: テーマ切替
- `updateProgress()`: 進捗表示を更新

## 関数詳細

### 各関数の詳細仕様

#### 初期化関連

##### `loadDataFromLocalStorage()`
- **機能**: ローカルストレージからデータを読み込む
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**:
  1. `localStorage`から`'toeicLearningData'`キーでデータを取得
  2. 取得データをJSON解析して各種データ（評価データ、再生回数等）を復元
  3. UIの値（評価単位数、再生速度）を更新
  4. ダークモード初期設定（システム設定に基づく）
- **例外処理**: 保存データの解析に失敗した場合、エラーをコンソールに出力

##### `loadDataFromCSV()`
- **機能**: CSVファイルからトランスクリプトデータを読み込む
- **パラメータ**: なし
- **戻り値**: Promise<void>
- **処理内容**:
  1. `fetch`APIを使用してCSVファイルを取得
  2. CSVデータを行ごとに分割して解析
  3. 各行から音声ファイルパスとテキストを抽出
  4. 抽出したデータから`audioFiles`配列を構築
- **例外処理**: CSVの読み込みに失敗した場合、エラーを表示してスローする

##### `loadMockData()`
- **機能**: デモ用のモックデータを生成する
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**: サンプルの音声データ100件を生成し、`audioFiles`配列に格納

#### UI管理関連

##### `updateUI()`
- **機能**: UI全体を更新する
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**:
  1. メインコンテンツ要素をクリア
  2. 評価単位数Mに基づいてセクションを作成
  3. 各セクションにスコア計算と表示を行う
  4. セクション内の音声アイテムを生成
  5. 進捗状況を更新

##### `createAudioItem(file)`
- **機能**: 音声アイテム要素を生成する
- **パラメータ**: `file` - 音声ファイル情報オブジェクト
- **戻り値**: HTMLElement - 生成された音声アイテム要素
- **処理内容**:
  1. 音声コントロール（再生、一時停止、停止、英文、習練ボタン）を生成
  2. 理解度評価オプションを生成
  3. ファイル情報表示を生成
  4. テキスト表示領域を生成
  5. すべての要素を結合して返却

##### `applyTheme()`
- **機能**: 現在のテーマ設定をUIに適用する
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**:
  1. `darkMode`フラグに基づいてbody要素にクラスを追加/削除
  2. テーマアイコンとテキストを更新

##### `toggleTheme()`
- **機能**: ライト/ダークモードを切り替える
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**:
  1. `darkMode`フラグを反転
  2. `applyTheme()`を呼び出してUIに反映
  3. 設定を保存

#### 音声制御関連

##### `playAudio(file)`
- **機能**: 音声ファイルを再生する
- **パラメータ**: `file` - 再生する音声ファイル情報オブジェクト
- **戻り値**: なし
- **処理内容**:
  1. 前回再生と同じファイルか判定
  2. 同じファイルなら再生回数をカウントアップ、異なるファイルなら再生回数リセット
  3. 最後に再生したファイルIDを更新
  4. 再生回数表示を更新
  5. 再生回数に応じて評価を自動更新
  6. Audio要素を生成し、再生速度を設定
  7. アクティブ状態のスタイル適用
  8. 音声再生開始
  9. データ保存

##### `playAudioForPractice(file)`
- **機能**: 習練モードで音声を再生する（再生回数カウントなし）
- **パラメータ**: `file` - 再生する音声ファイル情報オブジェクト
- **戻り値**: なし
- **処理内容**:
  1. 現在の再生を停止
  2. Audio要素を生成し、再生速度を設定
  3. アクティブ状態と習練モードのスタイル適用
  4. 音声再生開始
  5. データは保存しない（再生回数変更なし）

##### `pauseAudio()`
- **機能**: 再生中の音声を一時停止する
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**: 現在のAudio要素が存在する場合、一時停止メソッドを呼び出す

##### `stopAudio()`
- **機能**: 再生中の音声を停止する
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**:
  1. 現在のAudio要素が存在する場合、一時停止して位置を先頭に戻す
  2. 停止したファイルのIDを記録
  3. 音声関連の変数をリセット
  4. アクティブスタイルを解除
  5. 停止したファイルの再生回数表示を更新

##### `toggleText(fileId)`
- **機能**: 英文テキストの表示/非表示を切り替える
- **パラメータ**: `fileId` - 対象音声ファイルのID
- **戻り値**: なし
- **処理内容**:
  1. 該当の音声アイテム要素を検索
  2. テキスト領域の表示状態を反転
  3. 英文を表示した場合、再生回数を8に設定（「理解できない」評価に相当）
  4. 再生回数表示と評価を更新

#### 評価処理関連

##### `updatePlayCount(fileId)`
- **機能**: 再生回数表示を更新する
- **パラメータ**: `fileId` - 対象音声ファイルのID
- **戻り値**: なし
- **処理内容**:
  1. 再生回数表示要素を取得
  2. 現在の再生回数をテキスト表示
  3. 再生回数に応じてスタイルクラスを適用（カラーコーディング）

##### `updateEvaluationBasedOnPlayCount(fileId)`
- **機能**: 再生回数に基づいて評価を自動更新する
- **パラメータ**: `fileId` - 対象音声ファイルのID
- **戻り値**: なし
- **処理内容**:
  1. 現在の再生回数から適切な評価値を決定
  2. 該当の評価ラジオボタンを選択状態にする
  3. 評価データを保存

##### `saveEvaluation(fileId, rating)`
- **機能**: 評価データを保存する
- **パラメータ**: 
  - `fileId` - 対象音声ファイルのID
  - `rating` - 評価値（1〜5）
- **戻り値**: なし
- **処理内容**:
  1. 評価データと日時を`evaluationData`オブジェクトに保存
  2. UIを更新
  3. ローカルストレージにデータを保存

##### `calculateSectionScore(sectionFiles)`
- **機能**: セクションのスコアを計算する
- **パラメータ**: `sectionFiles` - セクション内の音声ファイル情報配列
- **戻り値**: オブジェクト - スコア情報（値、ラベル、星評価、最新日時）
- **処理内容**:
  1. セクション内の各ファイルの評価を取得
  2. 評価値に基づいてスコアを計算
  3. 最新の評価日時を追跡
  4. 全ファイルが評価済みか確認
  5. 星評価を計算
  6. スコア情報オブジェクトを返却

##### `updateProgress()`
- **機能**: 全体の進捗状況を更新する
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**:
  1. 全ファイル数と評価済みファイル数を計算
  2. 進捗率を計算し、進捗バーを更新
  3. セクションの平均点を計算
  4. 平均点を表示

#### データ管理関連

##### `saveDataToLocalStorage()`
- **機能**: データをローカルストレージに保存する
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**:
  1. 評価データ、再生回数、設定などを含むオブジェクトを作成
  2. オブジェクトをJSON文字列に変換
  3. `localStorage`に`'toeicLearningData'`キーで保存

##### `saveScrollPosition()`
- **機能**: スクロール位置を保存する
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**: 現在のスクロール位置を`localStorage`に保存

##### `restoreScrollPosition()`
- **機能**: 保存されたスクロール位置を復元する
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**: `localStorage`からスクロール位置を取得し、適用

##### `resetData()`
- **機能**: 評価データをリセットする
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**:
  1. 評価データと再生回数をクリア
  2. 最後に再生したファイルIDをリセット
  3. データを保存
  4. UIを更新

##### `clearLocalStorage()`
- **機能**: ローカルストレージを完全に消去する
- **パラメータ**: なし
- **戻り値**: なし
- **処理内容**:
  1. `localStorage`から`'toeicLearningData'`キーと`'scrollPosition'`キーを削除
  2. ページをリロード

##### `formatDate(date)` / `formatDateFull(date)`
- **機能**: 日付を表示用にフォーマットする
- **パラメータ**: `date` - Date オブジェクト
- **戻り値**: 文字列 - フォーマットされた日付表示
- **処理内容**: 日付を指定されたフォーマットに変換して返却

### パラメータ説明

#### `file` オブジェクト（音声ファイル情報）
- **構造**:
  ```javascript
  {
    id: "audio_1",               // ファイルの一意ID
    fileName: "sample_1.mp3",    // ファイル名
    filePath: "/path/to/audio",  // ファイルパス（オプション）
    text: "Transcript text..."   // 音声の英文テキスト
  }
  ```

#### `evaluationData` オブジェクト（評価データ）
- **構造**:
  ```javascript
  {
    "audio_1": {
      rating: 2,                        // 評価値（1-5）
      date: "2025-05-10T12:34:56.789Z"  // 評価日時（ISO形式）
    },
    // 他のファイルID...
  }
  ```

#### `playCountData` オブジェクト（再生回数データ）
- **構造**:
  ```javascript
  {
    "audio_1": 3,  // ファイルIDと再生回数
    "audio_2": 1,
    // 他のファイルID...
  }
  ```

#### `calculateSectionScore()` 戻り値オブジェクト
- **構造**:
  ```javascript
  {
    value: 75.5,                      // スコア数値
    label: "スコア: 75.5",            // 表示用ラベル
    stars: "★★★★☆",                 // 星評価表示
    latestDate: "2025-05-10T12:34:56.789Z" // 最新評価日時
  }
  ```

### 戻り値と例外処理

#### `loadDataFromCSV()`
- **戻り値**: Promise<void> - 非同期処理の完了を表すPromise
- **例外**:
  - CSVファイルが見つからない場合: `HTTP error! Status: 404`
  - CSVデータの解析に失敗した場合: エラーメッセージをコンソールに表示し、アラートダイアログを表示

#### `playAudio()`
- **例外**:
  - 音声ファイルの再生に失敗した場合: エラーメッセージをコンソールに表示し、アラートダイアログを表示

#### `loadDataFromLocalStorage()`
- **例外**:
  - 保存データの解析に失敗した場合: エラーメッセージをコンソールに表示

### 内部アルゴリズム説明

#### スコア計算アルゴリズム
1. セクション内の各ファイルの評価値を取得
2. 評価値に応じてポイントを計算:
   - 評価値1（1回で理解）: 100/M点（Mは評価単位数）
   - 評価値2（3回で理解）: 50/M点
   - 評価値3（5回で理解）: 33.3/M点
   - 評価値4（7回で理解）: 25/M点
   - 評価値5（理解できない）: 0点
3. 合計ポイントを計算
4. 星評価を算出:
   - 20点あたり1つ星（最大5つ星）
   - 例: スコア80点 = 4つ星（★★★★☆）

#### 再生回数による自動評価アルゴリズム
1. 現在の再生回数を取得
2. 回数に応じて評価値を設定:
   - 1回: 評価値1
   - 2-3回: 評価値2
   - 4-5回: 評価値3
   - 6-7回: 評価値4
   - 8回以上: 評価値5
3. 該当の評価ラジオボタンを選択状態に更新
4. 評価データを保存